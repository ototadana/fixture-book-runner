FixtureBookRunner の利用方法
============================

ここでは、FixtureBookRunner を使ってテスト実行するための手順を説明します。

0. テスト対象アプリケーションについて
-------------------------------------
ここでは、以下のような内容のシェルスクリプトのテストを例にして説明します。

```bash
#!/bin/sh

echo "Hello, $1"
```

上記のファイルは **Hello.sh** という名前をつけて任意のフォルダに保存してください。


*   (参考) 同様のものをバッチファイルで作るならば、以下のようになります。

    ```bat
    @echo off

    echo Hello, %1
    ```


1. テスト実行環境フォルダを作成する
-----------------------------------
まず、任意の場所にフォルダを作成し、その中に以下のフォルダを作成します。
*   conf  : データベース設定ファイルを格納する
*   lib   : JDBCドライバ (jarファイル) を格納する
*   tests : テスト実行用ファイルを格納する

作成例：

```bash
mkdir tutorial
cd tutorial
mkdir conf
mkdir lib
mkdir tests
```


    ─ tutorial/        ... テスト実行環境フォルダ
        ├── conf/        ... データベース設定ファイルを格納
        ├── lib/         ... JDBCドライバ (jarファイル) を格納
        └── tests/       ... テスト実行用ファイル（バッチファイル、Excelファイル）を格納


2. データベース利用設定を行う
-----------------------------
FixtureBookRunner がデータベースにアクセスできるようにするための設定を行います。

1.  利用するデータベース製品用の JDBC ドライバ (jarファイル) を lib フォルダにコピーする。
2.  conf フォルダに **db.properties** という名前のテキストファイルを作成し、
    以下のような形式で JDBC ドライバ設定を記述する。

        driverClassName=oracle.jdbc.OracleDriver
        url=jdbc:oracle:thin:@localhost:1521:xe
        username=scott
        password=tiger


3. テスト実行用Excelファイルの作成
----------------------------------
FixtureBook形式のテスト実行用 Excel ファイルを tests フォルダに作成します。  
ファイル名は **Test.xlsx** で終わる名前にします。

今回の例では **HelloTest.xlsx** という名前で、以下のような内容のファイルを作成しました。

![FixtureBook記述](./images/Tutorial-01.png?raw=true)

### 記述内容
Excel ファイル記述内容は以下の通りです。
*   「A.テストケース」の下に、このテストがなにを行うものかを記述する。
*   「D.パラメタ」の下には、テスト対象のシェルスクリプトやバッチファイルのパスと引数を記述する。
    *   バッチファイルの場合も拡張子（.bat や .cmd）を省略せずに書く必要がある。
    *   引数は一つづつ別の（下の）セルに記述する。
    *   ${...} という形式で環境変数（または設定ファイルで定義した変数）の指定が可能。  
        ここでは、${APP_DIR} でシェルスクリプトを格納したフォルダを指定している。
*   「E.取得データ」には、テスト対象のシェルスクリプトやバッチファイルの予想実行結果を記述する。
    *   予想結果としてチェックできるのは以下の内容です。
        *   exitCode : 終了コード
        *   stdout : 標準出力の内容
        *   stderr : 標準エラー出力の内容
    *   この例では、stdout に関しては、「Hello, World」の後に改行を入れています。

詳細な記述内容については、[テスト実行用 Excel ファイル作成方法](./Tutorial-FixtureBook.md)を参照してください。


4. 実行
-------
1.  環境変数 **APP_DIR** に Hello.sh を格納しているフォルダの指定をします。

    ```bash
    export APP_DIR=/home/user01/app/
    ```

    *   (参考) Windows 環境の例

        ```bat
        set APP_DIR=c:\Users\Owner\app
        ```

2.  **tutorial** フォルダ上で、**testexec** コマンドを実行します。

    引数なしで `testexec` と実行するか、`testexec tests` というふうに、
    テスト実行用Excelファイルを格納したフォルダを引数に指定して実行します。

    実行終了後、**reports** フォルダに JUnit 形式の XML ファイルとしてテスト結果が出力されます。
    もし引数なしで実行した場合は、reports フォルダに **tests.HelloTest.xml** というファイルができます。


### (参考) testexec コマンドの動作について
testexec コマンドは引数で指定したディレクトリに含まれるテスト実行ファイルを全て実行します。
従って、`testexec tests` で実行すれば、**tests** フォルダに含まれるファイルが実行されます。

#### 実行対象となるファイルの種類
*   ファイル名の末尾が以下のものに一致する場合、テスト実行ファイルとみなされ実行されます。
    *   "Test.xlsx", "Spec.xlsx" (Excel形式ファイル)
    *   "Test.sh", "Spec.sh", "Test", "Spec" (Unix シェルスクリプト)
    *   "Test.bat", "Test.cmd", "Spec.bat", "Spec.cmd" (Windows バッチファイル)
*   .xlsx ファイルは FixtureBook 形式ファイルとみなされ、
    ファイル内に記述された全てのテストケースが実行されます。
*   .bat もしくは .cmd は Windows バッチファイルとして実行されます。
*   上記以外のファイル名のものは実行可能ファイルとしてそのまま実行されます。

#### 実行対象ファイルの検索方法と実行順
*   001Test.xlsx と 001Test.bat というふうに同じ名前で拡張子のみが異なるファイルが存在する場合、
    001Test.bat が実行され、001Test.xlsx は実行されません。
*   testexec の引数で指定したフォルダの中に別のフォルダがあり、
    その中にテスト実行ファイルが存在する場合も実行対象となります。
*   testexec の引数で指定されたフォルダの中に複数のテスト実行ファイルが存在する場合、
    アルファベットの昇順に実行されます。
*   testexec の引数で指定されたフォルダの中に別のフォルダが存在する場合、
    より階層の浅いフォルダに含まれるファイルを先に実行します。
*   testexec の引数でフォルダを指定しなかった場合、現在のフォルダが指定されたものとみなされます。


5. 設定ファイルについて
-----------------------
conf フォルダの下に **Config.properties** というファイルがあれば、設定ファイルとして利用されます。
設定ファイルには以下の内容が記述できます。

設定項目    | 設定値
----------- | -----------------------------------
executable  | 実行可能ファイルとして検索対象となるファイル名末尾パターン。セミコロン区切りで複数指定可能（デフォルトは Test.xlsx;Test;Test.sh;Test.bat;Test.cmd;Spec.xlsx;Spec;Spec.sh;Spec.bat;Spec.cmd）
report      | レポートファイル出力先フォルダ（デフォルト: ./reports ）
port        | FixtureBook 実行サーバーのポート番号（デフォルト: 7878）

上記の項目以外にも任意の名前の項目を設定することができます。
ここで設定した項目は FixtureBook の「D.パラメタ」のコマンドパスや引数の中で ${設定項目名} という形で参照できます。



6. サンプルについて
-------------------
サンプルは以下のようなファイル構成になっています。

    ─ fixture-book-example/
        ├── app/             ... テスト対象アプリケーション
        │
        └── app-test/        ... テスト実行環境
            ├── conf/
            ├── lib/
            ├── reports/
            └── tests/           ... テスト実行用ファイル（バッチファイル、Excelファイル）
                    001-StartH2DatabaseTest         ... テスト用データベース起動スクリプト
                    002-CreateTable.sql             ... テスト用テーブル作成SQL
                    002-CreateTableTest             ... テスト用テーブル作成スクリプト
                    101-ExampleJobTest.xlsx         ... テスト実行用FixtureBookファイル(その1)
                    102-ExampleJobTest              ... テスト実行用スクリプト
                    102-ExampleJobTest.xlsx         ... テスト実行用FixtureBookファイル(その2)
                    999-ShutdownH2DatabaseTest      ... テスト用データベース停止スクリプト

**app-test** フォルダで `testexec` コマンドを実行すればテスト実行できます。
その際、以下の順番でテスト実行されます。

テスト実行ファイル                      | 実行内容
--------------------------------------- | -----------------------------------
1.  001-StartH2DatabaseTest             | テスト用のデータベースを起動する
2.  002-CreateTableTest                 | テストで使用するテーブルを作成する
3.  101-ExampleJobTest.xlsx             | テスト実行(1)を行う
4.  102-ExampleJobTest                  | テスト実行(2)を行う
5.  999-ShutdownH2DatabaseTest          | テスト用のデータベースを停止する

*   サンプル環境では、特定のデータベース環境に依存しないようにするために、
    アプリケーション内に組み込み可能なデータベース [H2](http://www.h2database.com) を使用しています。
*   001-StartH2DatabaseTest および  999-ShutdownH2DatabaseTest は H2 の起動・停止のためのジョブです。
    一般的なテスト環境においては、
    アプリケーションのテスト時にデータベースサービスがすでに起動していることが多いと思いますが、
    そのような場合には、こういったジョブは不要となるはずです。
*   この環境ではオンメモリデータベースを使い、データをストレージに保存していないため、
    002-CreateTableTest によりテストのたびにデータベーステーブルを作成しています。  
    従って、このフォルダの中で実際にテストを行っているのは、
    101-ExampleJobTest.xlsx および 102-ExampleJobTest という2つのファイルだけになります。

### 101-ExampleJobTest.xlsx の内容
以下の２つのテストケースが定義されています。

1.  指定されたIDのNAME項目の値を更新することができる
2.  実行時引数が二つない場合はエラーになる

#### テストケース 1: 指定されたIDのNAME項目の値を更新することができる
正常系のテストです。  
バッチアプリケーションのテストで一般的に行われる以下のような処理を行う例です。

1.  テストデータの準備を行う。

    1.  **B.テストデータクリア条件**に定義された条件で TEST_FB テーブルのレコードを削除する。
    2.  **C.テストデータ**に定義されたデータを TEST_FB テーブルに追加する。

2.  **D.パラメタ**に定義されたコマンドにより、テスト対象スクリプトを呼び出す。
3.  **E.取得データ**に定義された予想結果と実際のコマンド呼び出し結果を比較チェックする。
4.  **F.更新後データ**に定義された TEST_FB テーブルの予想結果と実際のテーブルの状態を比較チェックする。

#### テストケース 2: 実行時引数が二つない場合はエラーになる
エラー処理のテストです。  
ここでは、**D.パラメタ**にわざと間違った指定を行うことにより、
実装したエラー処理が正しく動いているかどうかをチェックしています。


### 102-ExampleJobTest の内容
こちらは、Excel ファイルを直接実行するのではなく、
[FixtureBookRunner の CLI(コマンドラインインターフェース)](./CLI.md) を利用して
シェルスクリプト経由で FixtureBook の機能を呼び出す例です。

102-ExampleJobTest には以下のように記述されています。

```bash
#!/bin/sh

java -cp ./conf:./lib/*:$FIXTURE_BOOK_DIR/lib/* com.xpfriend.fixture.runner.Setup ./tests/102-ExampleJobTest.xlsx main "指定されたIDのNAME項目の値を更新することができる" "$@"

../app/ExampleJob 1 xxx

java -cp ./conf:./lib/*:$FIXTURE_BOOK_DIR/lib/* com.xpfriend.fixture.runner.ValidateStorage ./tests/102-ExampleJobTest.xlsx main "指定されたIDのNAME項目の値を更新することができる" "$@"
```

このスクリプトでは以下の処理を行っています。

1.  Setup コマンドを呼び出し、**B.テストデータクリア条件** によるレコード削除と **C.テストデータ** に記述されたデータの投入を行う。
2.  テスト対象ジョブ (ExampleJob) を呼び出す。
3.  ValidateStorage コマンドを呼び出し、**F.更新後データ** によるデータチェックを行う。


CLIの詳細については[CLI リファレンス](./CLI.md)を参照してください。

